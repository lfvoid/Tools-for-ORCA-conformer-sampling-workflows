#!/bin/bash
############################################################################################################################
# A script for generating ORCA input files for all xyz files in the directory. The 'name' command can be used to specify 
# a selection of the xyz files in the directory.
#
# Note: Answering 'yes' to the 'Geometry modifier?' question will open a text file which lets you specify the contents of the 
# %geom block. The '%geom' and 'end' opening and closing the geom block are auto-generated by the script.
############################################################################################################################

#Command: NextLevelInput name

g=$(echo $1)
ls *$g*.xyz > mylist.txt # Make a list of all xyz files with 'name' in the title. 

echo "Method?"
read met
echo "Basis set?"
read basis
echo "Keywords?"
read key
echo "Charge and multiplicity?"
read cm
echo "Number of parallel processes?"
read core
echo "Geometry modifier (Hessian, Constraints, Scan), yes/no?" 
read geom
if [[ "$geom" == "yes" ]];  then
echo "Read Hessian? yes/no?"
read qh
nano input.txt 
echo "RRHO? yes/no"
read rrho
fi
echo "Memory per core?"
read mem
echo "Label for filenames?"
read label

# CASSCF-specific output
if [ "$met" == "casscf" ]; then

echo "
%casscf
nel 12
norb 12
mult 1
nroots 1
end

" > cas.txt

nano cas.txt

fi

while [ -s mylist.txt ]	      	      			#while the file is not empty
do
read -r f < mylist.txt					#Reads first line from mylist
NAME=`echo "$f" | cut -d'.' -f1`
sed -i '1d' mylist.txt

if [[ ${NAME: -3} == "trj" ]]; then  # Skip trajectory files auto-generated from geometry optimization jobs. 
        continue
fi

if [ "$met" == "casscf" ]; then

( echo "! $basis $key MOREAD

%moinp \"$NAME.gbw\"

%pal
nprocs=$core
end
"

if [ ! -z "$mem" ]; then
echo "%maxcore $mem
"
fi

cat cas.txt
if [[ "$geom" == "yes" ]];  then
echo "%geom"
cat input.txt 
echo "end
"

if [[ "$rrho" == "yes" ]];  then
echo "%freq"
echo "QuasiRRHO False"
echo "end
"
fi
fi


echo "* xyz $cm";
tail -n +3 $NAME.xyz;
echo "*" ) > $NAME-$label.inp

else

( echo "!$met $basis $key

%pal
nprocs=$core
end
"
if [ ! -z "$mem" ]; then
echo "%maxcore $mem"
echo ""
fi

if [[ "$geom" == "yes" ]];  then
echo "%geom"
cat input.txt 
if [[ "$qh" == "yes" ]];  then
echo "InHess Read
InHessName \"$NAME.hess\" "
fi
echo "end
"
if [[ "$rrho" == "yes" ]];  then
echo "%freq"
echo "QuasiRRHO False"
echo "end
"
fi
fi

echo "* xyz $cm";
tail -n +3 $NAME.xyz;
echo "*" ) > $NAME-$label.inp

fi
done

rm input.txt                                        # Remove unnecessary input file
rm cas.txt                                          # Remove CASSCF input file
rm mylist.txt
