#!/bin/bash
# Call the script using the command: rmsd name

####################################################################################################################################
# Script for calculating root mean square distances between conformer pairs in internal coordinates. Same atmoic ordering is assumed.
# All output files with the input variable 'name' in the name are red. It is assumed that the xyz file auto-generated by 
# each optimization run exists in the same directory.
#####################################################################################################################################

# For other users, you may want to change the variable name specifying the location of the python script:
snakepit="/users/lfranzon/Snakepit"


f=$(echo $1)

confnum=$(ls *$f*.out | wc -l)
batch=($(ls -1 *$f*.out))

# Count the number of atoms in the molecule from the xyz file of the first conformer.
noa=$(head -1 ${batch[1]%.out}.xyz)
let "noa1=noa+1"
let "noa2=noa+2"

echo "$confnum conformers, $noa atoms."

echo "Pick output file with reference internal coordinates."
read refgeom

grep "INTERNAL COORDINATES (ANGST" -A$noa1 $refgeom.out | tail -$noa2 > Refgeom.xyz

# Remove first two lines from Refgeom.xyz and add this instead.
sed -i '1,2d' Refgeom.xyz
sed -i "1s/^/ E      c1  c2  c3    R                A              D\n/" Refgeom.xyz

# Print out all internal geometries
for g in ${batch[@]}; do
    FILE=`echo "$g" | cut -d'.' -f1`
    grep "INTERNAL COORDINATES (ANGST" -A$noa1 $FILE.out | tail -$noa2 > $FILE.int
    sed -i '1,2d' $FILE.int
    sed -i "1s/^/ E      c1  c2  c3    R                A              D\n/" $FILE.int
done

# Redifine batch so that the python script picks the right files.
batch=($(ls -1 *$f*.int))

echo "$confnum internal geometries printed."

# Select the locations of the methyl groups, since these are needed for methyl rotations.
echo "How many methyl groups? (These will be rotated in the internal geometries during RMSD calculations)"
read nMet
if [ -z "$nMet" ]; then nMet="0"; fi

Met=()

# Loop from 1 to nMet
for ((i=1; i<=nMet; i++)); do
    echo "Enter index of first H atom in methyl number $i: (indexing starts from 1)"
    read H
    Met+=("$H")
done

module load python-data

echo "Now calling the python code."
python3 $snakepit/RMSDInt.py $noa $confnum $nMet "${Met[@]}" "${batch[@]}"

